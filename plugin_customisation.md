# Plugins and customisation

Start development environment

    . /usr/lib/ckan/default/bin/activate

    cd /usr/lib/ckan/default/src
    paster --plugin=ckan create -t ckanext ckanext-saerischema

`ckanext-saerischema` is the name of the new plugin

    cd /usr/lib/ckan/default/src/ckanext-saerischema

notice that if you created a repo in github you can connect to it and run the following

    git init
    git add *
    git commit -m "Empty plugin"

Every CKAN page is generated by rendering a particular template. For each page of a CKAN site thereâ€™s a corresponding template file. For example the front page is generated from the `ckan/templates/home/index.html` file, the about page is generated from `ckan/templates/home/about.html`, the datasets page at dataset is generated from `ckan/templates/package/search.html`, etc.

Create the `ckanext-example_theme/ckanext/example_theme/templates` directory

    mkdir -p ckanext/saerischema/templates/

To customize pages, our plugin needs to register its own custom template directory containing template files that override the default ones.

Edit the `ckanext-example_theme/ckanext/example_theme/plugin.py` file that we created earlier the page of reference in the CKAN doc is this:  https://docs.ckan.org/en/2.8/extensions/adding-custom-fields.html

    sudo nano ckanext/saerischema/plugin.py

## encoding: utf-8

`plugin.py`

````
import ckan.plugins as p
import ckan.plugins.toolkit as tk
from ckan.plugins.toolkit import Invalid
import logging

log = logging.getLogger (__name__)
````

Define a custom validator in the extension. Validators can be shared between extensions by registering them with the IValidators interface.

Our validator converts the bounding box values into a spatial extra It takes the values from `saeri_north/south/east/west` and creates a

- 1 GeoJSON string which is placed into the extra called *spatial*
- 2 param (value) return value, or it can be converted if you wish
- 3 param (value, context) likewise. nb can raise(Invalid) if you wish
- 4 param (key, flattened_data, errors, context) return None as it can update stuff

    sudo nano ckanext/saerischema/plugin.py

````
def SaerischemaPlugin_validator_convert_bbox_to_spatial(key, flattened_data, errors, context):
    log.debug("SaerischemaPlugin convert_bbox_to_spatial")
    log.debug("SaerischemaPlugin flattened_data is %s" % (str(flattened_data)))

    # Lookup the entered values (warning: might not be validated/converted yet)
    n = float(flattened_data[('saeri_north_latitude',)])
    s = float(flattened_data[('saeri_south_latitude',)])
    w = float(flattened_data[('saeri_west_longitude',)])
    e = float(flattened_data[('saeri_east_longitude',)])


    # Construct GeoJSON format from bounding box
    # eg. '{ "type": "Polygon", "coordinates": [[ [ -59.26,-51.94 ], [ -57.62,-51.94 ], [ -57.62,-51.16 ], [ -59.26,-51.16 ], [ -59.26,-51.94 ] ]] }'
    geojson = '{ "type": "Polygon", "coordinates": [ [ '
    geojson += '[ %f, %f ], ' % (w,n)
    geojson += '[ %f, %f ], ' % (e,n)
    geojson += '[ %f, %f ], ' % (e,s)
    geojson += '[ %f, %f ], ' % (w,s)
    geojson += '[ %f, %f ] '  % (w,n)
    geojson += '] ] }'

    log.debug("SaerischemaPlugin N %f" % (n))
    log.debug("SaerischemaPlugin S %f" % (s))
    log.debug("SaerischemaPlugin W %f" % (w))
    log.debug("SaerischemaPlugin E %f" % (e))
    log.debug("SaerischemaPlugin GeoJSON %s" % (geojson))

    # check if spatial exists first
    # what to do if it does?
    if ('spatial',) in flattened_data:
        log.debug("SaerischemaPlugin existing spatial (will be overwritten) was %s" % (flattened_data[('spatial',)]))

    # Give the spatial extra the new GeoJSON value.
flattened_data[('spatial',)] = geojson

#define the plugin class

class SaerischemaPlugin(p.SingletonPlugin, tk.DefaultDatasetForm):
    p.implements(p.IDatasetForm)

# Declare that this class implements IConfigurer and Validator.
    p.implements(p.IConfigurer)
    p.implements(p.IValidator)

    log.debug("SaerischemaPlugin created")

# The create_package_schema() function is used whenever a new dataset
# is created, we'll want update the default schema and insert our
# custom field here. We will fetch the default schema defined in
 # default_create_package_schema() by running
 # create_package_schema()'s super function and update it.

       def create_package_schema(self):
           log.debug("SaerischemaPlugin create_package_schema called")
           # get the default schema in our plugin
           schema = super(SaerischemaPlugin, self).create_package_schema()
           # add our custom fields
           schema = self._modify_package_schema(schema)
   return schema
````

The CKAN schema is a dictionary where the key is the name of the field and the value is a list of validators and converters. Here we have a validator to tell CKAN to not raise a validation error if the value is missing and a converter to convert the value to and save as an extra.

Back to the `plugin.py` editing

    sudo nano ckanext/saerischema/plugin.py

````
# Caller from create_package_schema and update_package_schema.
   def _modify_package_schema(self, schema):
           log.debug("SaerischemaPlugin _modify_package_schema called")

           schema.update({
               # SAERISCHEMA_UPDATE_START
               'saeri_region': [tk.get_validator('ignore_missing'),
                                    tk.get_converter('convert_to_extras')]
               ,'saeri_organisation': [tk.get_validator('ignore_missing'),
                                    tk.get_converter('convert_to_extras')]
               ,'saeri_language': [tk.get_validator('ignore_missing'),
                                    tk.get_converter('convert_to_extras')]
               ,'saeri_topic_category': [tk.get_validator('ignore_missing'),
                                    tk.get_converter('convert_to_extras')]
               ,'saeri_temporal_extent': [tk.get_validator('ignore_missing'),
                                    tk.get_converter('convert_to_extras')]
               ,'saeri_dataset_reference_date': [tk.get_validator('ignore_missing'),
                                    tk.get_converter('convert_to_extras')]
               ,'saeri_lineage': [tk.get_validator('ignore_missing'),
                                    tk.get_converter('convert_to_extras')]
               ,'saeri_west_longitude': [tk.get_validator('ignore_missing'),
                                    tk.get_converter('convert_bbox_to_spatial'),
                                    tk.get_converter('convert_to_extras')]
               ,'saeri_south_latitude': [tk.get_validator('ignore_missing'),
                                    tk.get_converter('convert_to_extras')]
               ,'saeri_east_longitude': [tk.get_validator('ignore_missing'),
                                    tk.get_converter('convert_to_extras')]
               ,'saeri_north_latitude': [tk.get_validator('ignore_missing'),
                                    tk.get_converter('convert_to_extras')]
               ,'saeri_spatial_reference_system': [tk.get_validator('ignore_missing'),
                                    tk.get_converter('convert_to_extras')]
               ,'saeri_responsible_organisation_name': [tk.get_validator('ignore_missing'),
                                    tk.get_converter('convert_to_extras')]
               ,'saeri_contact_mail_address': [tk.get_validator('ignore_missing'),
                                    tk.get_converter('convert_to_extras')]
               ,'saeri_responsible_party_role': [tk.get_validator('ignore_missing'),
                                    tk.get_converter('convert_to_extras')]
               ,'saeri_access_limitations': [tk.get_validator('ignore_missing'),
                                    tk.get_converter('convert_to_extras')]
               ,'saeri_use_constraints': [tk.get_validator('ignore_missing'),
                                    tk.get_converter('convert_to_extras')]
               ,'saeri_data_format': [tk.get_validator('ignore_missing'),
                                    tk.get_converter('convert_to_extras')]
               ,'saeri_update_frequency': [tk.get_validator('ignore_missing'),
                                    tk.get_converter('convert_to_extras')]
               ,'saeri_accuracy': [tk.get_validator('ignore_missing'),
                                    tk.get_converter('convert_to_extras')]
               ,'saeri_resource_type': [tk.get_validator('ignore_missing'),
                                    tk.get_converter('convert_to_extras')]
               ,'saeri_original_title': [tk.get_validator('ignore_missing'),
                                    tk.get_converter('convert_to_extras')]
               ,'saeri_metadata_date': [tk.get_validator('ignore_missing'),
                                    tk.get_converter('convert_to_extras')]
               ,'saeri_metadata_point_of_contact': [tk.get_validator('ignore_missing'),
                                    tk.get_converter('convert_to_extras')]
               ,'saeri_status': [tk.get_validator('ignore_missing'),
                                    tk.get_converter('convert_to_extras')]
               # SAERISCHEMA_UPDATE_END
           })
           # If the schema doesn't already have a 'spatial' extra then add it now
           if not 'spatial' in schema:
               log.debug("SaerischemaPlugin _modify_package_schema adding spatial to schema")
               schema.update({'spatial': [tk.get_validator('ignore_missing'),
                                    tk.get_converter('convert_to_extras')]})
   return schema

#We will want to change the update_package_schema() function
# with the same update code.

def update_package_schema(self):
        log.debug("SaerischemaPlugin update_package_schema called")
        schema = super(SaerischemaPlugin, self).update_package_schema()
        # add our custom fields
        schema = self._modify_package_schema(schema)
return schema
````

The `show_package_schema()` is used when the `package_show()` action is called

We want the `default_show_package_schema` to be updated to include our custom fields. This time, instead of converting to an extras field, we want our field to be converted from an extras field. So we want to use the `convert_from_extras()` converter. Continue adding to the `plugin.py` file

    sudo nano ckanext/saerischema/plugin.py

````
    def show_package_schema(self):
        log.debug("SaerischemaPlugin show_package_schema called")
        schema = super(SaerischemaPlugin, self).show_package_schema()
  #log.debug("SaerischemaPlugin schema before = {}".format(str(schema)))
  schema.update({
              # SAERISCHEMA_SHOW_START
              'saeri_region': [tk.get_converter('convert_from_extras'),
                              tk.get_validator('ignore_missing')]
              ,'saeri_organisation': [tk.get_converter('convert_from_extras'),
                              tk.get_validator('ignore_missing')]
              ,'saeri_language': [tk.get_converter('convert_from_extras'),
                              tk.get_validator('ignore_missing')]
              ,'saeri_topic_category': [tk.get_converter('convert_from_extras'),
                              tk.get_validator('ignore_missing')]
              ,'saeri_temporal_extent': [tk.get_converter('convert_from_extras'),
                              tk.get_validator('ignore_missing')]
              ,'saeri_dataset_reference_date': [tk.get_converter('convert_from_extras'),
                              tk.get_validator('ignore_missing')]
              ,'saeri_lineage': [tk.get_converter('convert_from_extras'),
                              tk.get_validator('ignore_missing')]
              ,'saeri_west_longitude': [tk.get_converter('convert_from_extras'),
                              tk.get_validator('ignore_missing')]
              ,'saeri_south_latitude': [tk.get_converter('convert_from_extras'),
                              tk.get_validator('ignore_missing')]
              ,'saeri_east_longitude': [tk.get_converter('convert_from_extras'),
                              tk.get_validator('ignore_missing')]
              ,'saeri_north_latitude': [tk.get_converter('convert_from_extras'),
                              tk.get_validator('ignore_missing')]
              ,'saeri_spatial_reference_system': [tk.get_converter('convert_from_extras'),
                              tk.get_validator('ignore_missing')]
              ,'saeri_responsible_organisation_name': [tk.get_converter('convert_from_extras'),
                              tk.get_validator('ignore_missing')]
              ,'saeri_contact_mail_address': [tk.get_converter('convert_from_extras'),
                              tk.get_validator('ignore_missing')]
              ,'saeri_responsible_party_role': [tk.get_converter('convert_from_extras'),
                              tk.get_validator('ignore_missing')]
              ,'saeri_access_limitations': [tk.get_converter('convert_from_extras'),
                              tk.get_validator('ignore_missing')]
              ,'saeri_use_constraints': [tk.get_converter('convert_from_extras'),
                              tk.get_validator('ignore_missing')]
              ,'saeri_data_format': [tk.get_converter('convert_from_extras'),
                              tk.get_validator('ignore_missing')]
              ,'saeri_update_frequency': [tk.get_converter('convert_from_extras'),
                              tk.get_validator('ignore_missing')]
              ,'saeri_accuracy': [tk.get_converter('convert_from_extras'),
                              tk.get_validator('ignore_missing')]
              ,'saeri_resource_type': [tk.get_converter('convert_from_extras'),
                              tk.get_validator('ignore_missing')]
              ,'saeri_original_title': [tk.get_converter('convert_from_extras'),
                              tk.get_validator('ignore_missing')]
              ,'saeri_metadata_date': [tk.get_converter('convert_from_extras'),
                              tk.get_validator('ignore_missing')]
              ,'saeri_metadata_point_of_contact': [tk.get_converter('convert_from_extras'),
                              tk.get_validator('ignore_missing')]
              ,'saeri_status': [tk.get_converter('convert_from_extras'),
                              tk.get_validator('ignore_missing')]
              # SAERISCHEMA_SHOW_END
          })
          # If the schema doesn't already have a 'spatial' extra then add it now
          if not 'spatial' in schema:
              log.debug("SaerischemaPlugin show_package_schema adding spatial to schema")
              schema.update({'spatial': [tk.get_converter('convert_from_extras'),
                              tk.get_validator('ignore_missing')]})
  return schema
````

The `package_types()` function defines a list of dataset types that this plugin handles. Each dataset has a field containing its type.

Plugins can register to handle specific types of dataset and ignore others.

Since our plugin is not for any specific type of dataset and we want our plugin to be the default handler, we update the plugin code to contain the following, wich is addedd to the `plugin.py` file

    sudo nano ckanext/saerischema/plugin.py

````
     def is_fallback(self):
         # Return True to register this plugin as the default handler for
         # package types not handled by any other IDatasetForm plugin.
         return True

     def package_types(self):
         # This plugin doesn't handle any special package types, it just
         # registers itself as the default (above).
 return []
````

In order for our new field to be visible on the CKAN front-end, we need toupdate the templates. Make the plugin implement the IConfigurer interface.

This interface allows to implement a function `update_config()` that allows us to update the CKAN config, in our case we want to add an additional location for CKAN to look for templates. Add the following to `plugin.py`

    sudo nano ckanext/saerischema/plugin.py

````
    def update_config(self, config):

# Add this plugin's templates dir to CKAN's extra_template_paths, so
# that CKAN will use this plugin's custom templates.

tk.add_template_directory(config, 'templates')
tk.add_publc_directory(config, 'public')
tk.add_resource('fantastic', 'saerischema')
log.debug("SaerischemaPlugin update_config called")
````

Create the package (because an extension is a package) and snippets directories names of the snippets should be unique as if there are 2 plugins with snippet files with the same name, one of the sippets will overwrite the other best practice is to use `custom_plugin_NAME.html`

    mkdir -p ckanext/saerischema/templates/package/snippets/

We need to override a few templates in order to get our custom field rendered.

    cd ckanext/saerischema/templates/package/snippets/

Create a file called package_metadata_fields.html and edit so it contains

This overrides the custom_fields block with an empty block so the default CKAN custom fields form does not render.

    sudo nano package_metadata_fields.html

````
{% ckan_extends %}

{# You could remove 'free extras' from the package form like this, but we keep them for this example's tests.
  {% block custom_fields %}
  {% endblock %}
#}

{# Remove the built-in fields which conflict with our own custom fields #}

{% block package_metadata_author %}
{% endblock %}

{% block package_metadata_fields_maintainer %}
{% endblock %}
````
Create a file called package_basic_fields.html and edit so it contains

This adds our custom_text field to the editing form as ultimately we want to display our custom_text field on the dataset page

    sudo nano package_basic_fields.html

[see text in github]

Finally, create a file additional_info.html and edit so it contains

This template overrides the default extras rendering on the dataset page and replaces it to just display our custom field

    sudo nano additional_info.html

[see text in github]

install the extension

    /usr/lib/ckan/default/bin/activate
    cd /usr/lib/ckan/default/src/ckanext-saerischema
    python setup.py develop

enable the plugins by adding them to the plugin list

    sudo nano etc/ckan/default/development.ini

    ckan.plugins = stats text_view recline_view saerischema

restart ckan in production mode

    cp /etc/ckan/default/development.ini /etc/ckan/default/production.ini
    sudo service apache2 restart

backup the database

    pg_dump --blobs --clean --if-exists --create --inserts -d ckan_default -h localhost -U ckan_default -f ~/ckan_default.initialised_with_plugin.pg_dump

send the extension to github

````
echo "# ckanext-saerischema" >> README.md
git add README.md
git status
git diff ckanext/saerischema/plugin.py
git add ckanext/saerischema/plugin.py
git commit -m "First successful plugin"
git remote add origin https://github.com/SAERI-Datacenter/ckanext-saerischema.git
git push -u origin master
````
